<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <script src="https://cdn.firebase.com/js/client/2.2.9/firebase.js"></script>
	<title>
		Cub Scout
	</title>
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>
  <div class="container">
  <div class="page-header">
    <h1>Individual Cub Scout Record</h1>
  </div>
  </div>
  <div id="personal-info" class="container"></div>
  <div id="bobcat-info" class="container"></div>
  <div id="wolf-info" class="container"></div>
  <div id="bear-info" class="container"></div>
  <div id="webelo-info" class="container"></div>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.1.3/mustache.min.js"></script>
  <script type="text/javascript">
    (function( $, window, document, undefined ) {
      
      var scoutKey = window.location.search.substring(1);
      var fbScout = new Firebase( "https://akela.firebaseio.com/scouts/" + scoutKey );
      var scout = undefined;
      var fbBobcat = undefined;
      var fbWolf = undefined;
      var fbBear = undefined;
      var fbWebelos = undefined;

      function onError( error ) {
        alert( error );
      }
      
      function onPersonalInfo( snapshot ) {
        scout = snapshot.val();
        
        $.get( "templates/scout.mst", function( template ) {
          var rendered = Mustache.render( template, scout );
          $( "#personal-info" ).html( rendered );
        });
        
        // now that we have the scout record back from the
        // database we can try to show their scout history
        showBobcat();
        showWolf();
        showBear();
      }
      
      function updatePersonalInfo() {
        if( fbScout ) {
          fbScout.update( {
            council: $( "#council" ).val(),
            unitnumber: $( "#unitnumber" ).val(),
            name: $( "#name" ).val(),
            birthday: $( "#birthday" ).val(),
            phone: $( "#phone" ).val(),
            email: $( "#email" ).val()
          });
        }
      }
      
      function showBobcat() {
        if( scout && scout.bobcat ) {
          if( !fbBobcat ) {
            fbBobcat = new Firebase( "https://akela.firebaseio.com/bobcats/" + scout.bobcat );
          }
          
          fbBobcat.on( 'value', onBobcat, onError );
        } else {
          onBobcat();
        }
      }
      
      function addBobcat() {
        if( scout && !scout.bobcat ) {
          var bobcats = new Firebase( "https://akela.firebaseio.com/bobcats/" );
          
          if( !fbBobcat ) {
            fbBobcat = new Firebase( "https://akela.firebaseio.com/bobcats/" + scout.bobcat );
          }
          
          fbBobcat = bobcats.push( { scout: scoutKey });
          fbScout.update({ bobcat: fbBobcat.key() })
          fbBobcat.on( 'value', onBobcat, onError );
        }
      }
      
      function onBobcat( snapshot ) {
        $.get( "templates/bobcat.mst", function( template ){
          var rendered = Mustache.render( template, snapshot ? snapshot.val() : {} );
          $( "#bobcat-info" ).html( rendered );
        });
      }
      
      function updateBobcat() {
        if( fbBobcat ) {
          fbBobcat.update( {
            oath: $( "#oath" ).prop( "checked" ),
            law: $( "#law" ).prop( "checked" ),
            sign: $( "#sign" ).prop( "checked" ),
            handshake: $( "#handshake" ).prop( "checked" ),
            motto: $( "#motto" ).prop( "checked" ),
            salute: $( "#salute" ).prop( "checked" ),
            parent: $( "#bobcat-parent" ).prop( "checked" )
          });
        }
      }
      
      function showWolf() {
        if( scout && scout.wolf ) {
          if( !fbWolf ) {
            fbWolf = new Firebase( "https://akela.firebaseio.com/wolves/" + scout.wolf );
          }
          
          fbWolf.on( 'value', onWolf, onError );
        } else {
          onWolf();
        }
      }
      
      function addWolf() {
        if( scout && !scout.wolf ) {
            var wolves = new Firebase( "https://akela.firebaseio.com/wolves/" );
            
            if( !fbWolf ) {
              fbWolf = new Firebase( "https://akela.firebaseio.com/wolves/" + scout.wolf );
            }

            fbWolf = wolves.push( { scout: scoutKey });
            fbScout.update({ wolf: fbWolf.key() });
            fbWolf.on( 'value', onWolf, onError );
        }
      }
      
      function onWolf( snapshot ){
        $.get( "templates/wolf.mst", function( template ) {
          var rendered = Mustache.render( template, snapshot ? snapshot.val() : {} );
          $( "#wolf-info" ).html( rendered );
        });
      }
      
      function updateWolf() {
        if( fbWolf ) {
          fbWolf.update( {
            callOfTheWild: $( "#call-of-the-wild" ).prop( "checked" ),
            councilFire: $( "#council-fire" ).prop( "checked" ),
            dutyToGod: $( "#duty-to-god" ).prop( "checked" ),
            howlingAtTheMoon: $( "#howling-at-the-moon" ).prop( "checked" ),
            pawsOnThePath: $( "#paws-on-the-path" ).prop( "checked" ),
            runningWithThePack: $( "#running-with-the-pack" ).prop( "checked" ),
            elective: $( "#wolf-elective" ).prop( "checked" ),
            parent: $( "#wolf-parent" ).prop( "checked" ),
            cyberChip: $( "#wolf-cyber-chip" ).prop( "checked" )
          });
        }
      }
      
      function showBear() {
        if( scout && scout.bear ) {
          if( !fbBear )
          {
            fbBear = new Firebase( "https://akela.firebaseio.com/bears/" + scout.bear );
          }
          
          fbBear.on( 'value', onBear, onError );
        } else {
          onBear();
        }
      }
      
      function addBear() {
        if( scout && !scout.bear ) {
          var bears = new Firebase( "https://akela.firebaseio.com/bears/" );
          
          if( !fbBear )
          {
            fbBear = new Firebase( "https://akela.firebaseio.com/bears/" + scout.bear );
          }
          
          fbBear = bears.push( {scout: scoutKey} );
          fbScout.update( {bear: fbBear.key()} );
          fbBear.on( 'value', onBear, onError );
        }
      }
      
      function onBear( snapshot ) {
        $.get( "templates/bear.mst", function( template ) {
          var rendered = Mustache.render( template, snapshot ? snapshot.val() : {} );
          $( "#bear-info" ).html( rendered );
        } );
      }
      
      function updateBear() {
        if( fbBear ) {
          fbBear.update( {
            bearClaws: $( "#bear-claws" ).prop( "checked" ),
            bearNecessities: $( "#bear-necessities" ).prop( "checked" ),
            fellowshipAndDutyToGod: $( "#fellowship-and-duty-to-god" ).prop( "checked" ),
            furFeathersAndFerns: $( "#fur-feathers-and-ferns" ).prop( "checked" ),
            grinAndBearIt: $( "#grin-and-bear-it" ).prop( "checked" ),
            pawsForAction: $( "#paws-for-action" ).prop( "checked" ),
            elective: $( "#bear-elective" ).prop( "checked" ),
            parent: $( "#bear-parent" ).prop( "checked" ),
            cyberChip: $( "#bear-cyber-chip" ).prop( "checked" )
          } );
        }
      }

      function onUpdate() {
        updatePersonalInfo();
        updateBobcat();
        updateWolf();
        updateBear();
      }

      $( document ).ready( function() {
        fbScout.on( 'value', onPersonalInfo, onError );
        $( document ).on( "click", ".update", onUpdate );
        $( document ).on( "click", ".add-bobcat", addBobcat );
        $( document ).on( "click", ".add-wolf", addWolf );
        $( document ).on( "click", ".add-bear", addBear );
      } );
      
    })( jQuery, window, document );
  </script>
</body>
</html>